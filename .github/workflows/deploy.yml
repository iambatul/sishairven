# =============================================================================
# HAIRVEN SALON - GITHUB ACTIONS DEPLOYMENT WORKFLOW
# =============================================================================
# Automates testing, building, and deployment on push to main
# =============================================================================

name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ---------------------------------------------------------------------------
  # Test Job
  # ---------------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run type check
      run: npm run check
      continue-on-error: true
    
    - name: Run build
      run: npm run build
    
    - name: Check for security vulnerabilities
      run: npm audit --audit-level=moderate
      continue-on-error: true

  # ---------------------------------------------------------------------------
  # Build and Push Docker Image
  # ---------------------------------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # ---------------------------------------------------------------------------
  # Deploy to Production Server
  # ---------------------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/hairven
          
          # Pull latest changes
          git pull origin main
          
          # Run database migrations
          ./database/migrate.sh up
          
          # Deploy with Docker Compose
          docker-compose pull
          docker-compose up -d --build
          
          # Cleanup old images
          docker image prune -f
          
          # Health check
          sleep 10
          curl -sf http://localhost:3000/healthz || exit 1
          
          echo "Deployment completed successfully!"

  # ---------------------------------------------------------------------------
  # Post-Deployment Verification
  # ---------------------------------------------------------------------------
  verify:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Verify deployment
      run: |
        # Wait for deployment to settle
        sleep 30
        
        # Check health endpoint
        curl -sf https://sishairven.com/healthz || exit 1
        
        # Check main pages
        curl -sf https://sishairven.com/ || exit 1
        curl -sf https://sishairven.com/about || exit 1
        curl -sf https://sishairven.com/contact || exit 1
        
        echo "All checks passed!"
    
    - name: Notify on success
      if: success()
      run: |
        echo "✅ Deployment to production completed successfully!"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment failed!"
        # Add notification logic here (Slack, email, etc.)
